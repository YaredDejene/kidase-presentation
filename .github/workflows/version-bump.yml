name: Version Bump

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  bump:
    name: Bump version and create release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Sync version from tag
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Setting version to $VERSION"
          CURRENT=$(jq -r '.version' package.json)
          if [ "$CURRENT" = "$VERSION" ]; then
            echo "Version already up to date ($VERSION), skipping commit."
            echo "CHANGED=false" >> "$GITHUB_ENV"
          else
            jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json
            jq --arg v "$VERSION" '.version = $v' src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json
            sed -i "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
            echo "CHANGED=true" >> "$GITHUB_ENV"
          fi

      - name: Commit version bump
        if: env.CHANGED == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json src-tauri/tauri.conf.json src-tauri/Cargo.toml
          git commit -m "chore: bump version to ${{ env.VERSION }}"
          git push origin main

      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --notes "See the assets below to download and install." \
            --latest
